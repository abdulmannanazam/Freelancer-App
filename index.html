<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Freelancer CRM + Finance Tracker</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--ink:#111;--muted:#6b7280;--primary:#4f46e5;--danger:#ef4444;--ok:#059669
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px}
  .kpi{flex:1 1 230px}
  .kpi h3{margin:0 0 8px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
  .kpi .v{font-size:22px;font-weight:800}
  .toolbar{display:flex;gap:8px;align-items:center;margin:14px 0;flex-wrap:wrap}
  input,select,button,textarea{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff;font:inherit}
  textarea{resize:vertical}
  button{cursor:pointer;transition:.2s}
  button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  button.primary:hover{filter:brightness(.95)}
  button.ghost{background:transparent}
  button.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .tabs{display:flex;gap:6px;margin-top:12px}
  .tab{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#111}
  .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-weight:600;color:var(--muted);text-align:left}
  td{background:#fff;padding:12px;border-top:1px solid #eee;border-bottom:1px solid #eee}
  tr td:first-child{border-left:1px solid #eee;border-top-left-radius:12px;border-bottom-left-radius:12px}
  tr td:last-child{border-right:1px solid #eee;border-top-right-radius:12px;border-bottom-right-radius:12px}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .badge{padding:4px 8px;border-radius:999px;font-size:12px;display:inline-block}
  .ok{background:rgba(16,185,129,.12);color:#065f46}
  .warn{background:rgba(245,158,11,.14);color:#92400e}
  .actions{display:flex;gap:4px;flex-wrap:wrap}
  .actions button{border:none;background:transparent;padding:6px;border-radius:6px}
  .actions button:hover{background:rgba(0,0,0,.05)}
  .drawer{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-start;justify-content:flex-end;z-index:100}
  .panel{width:520px;max-width:92vw;background:#fff;height:100%;padding:18px 16px 24px;overflow-y:auto}
  .panel h2{margin:8px 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .line{display:grid;grid-template-columns:1fr;gap:10px}
  .hidden{display:none}
  .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,0,0,.1);border-radius:50%;border-top-color:var(--primary);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .auth{max-width:460px;margin:32px auto;padding:24px}
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--ink);color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:none}
  .vault{display:flex;gap:8px;align-items:center}
  .hint{font-size:12px;color:var(--muted)}
  @media (max-width: 780px){
    .grid{grid-template-columns:1fr}
    table{display:block;overflow-x:auto;white-space:nowrap}
    .kpi{flex:1 1 100%}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Freelancer CRM</h1>

  <!-- AUTH -->
  <section id="authBox" class="card auth">
    <h3>Login or Sign up</h3>
    <div class="grid">
      <input id="authEmail" type="email" placeholder="Email" />
      <input id="authPass" type="password" placeholder="Password" />
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnLogin" class="primary">Login</button>
        <button id="btnSignup">Sign up</button>
        <button id="btnReset" style="margin-left:auto;font-size:13px">Forgot password?</button>
      </div>
      <p class="muted" style="margin:0">Each account has isolated data. Credentials are encrypted locally with your vault key.</p>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">
    <div class="row">
      <div class="card kpi"><h3>Clients</h3><div class="v" id="kpiClients">0</div></div>
      <div class="card kpi"><h3>Projects</h3><div class="v" id="kpiProjects">0</div></div>
      <div class="card kpi"><h3>Paid</h3><div class="v" id="kpiPaid">PKR 0</div></div>
      <div class="card kpi"><h3>Receivables</h3><div class="v" id="kpiDue">PKR 0</div></div>
    </div>

    <div class="toolbar">
      <input id="q" placeholder="Search (client/project/domain/email/phone)" style="flex:1;min-width:260px"/>
      <select id="filterTab">
        <option value="clients">Clients</option>
        <option value="projects" selected>Projects</option>
        <option value="invoices">Invoices</option>
      </select>
      <button class="primary" id="btnNew">+ New</button>
      <button id="btnExport">Export Excel</button>
      <div class="vault" style="margin-left:auto">
        <input id="vaultKey" type="password" placeholder="Vault Key (for credentials)" style="min-width:220px">
        <button id="btnLogout" class="ghost">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="projects">Projects</button>
      <button class="tab" data-tab="clients">Clients</button>
      <button class="tab" data-tab="invoices">Invoices</button>
    </div>

    <!-- TABLES -->
    <div class="card" id="viewProjects">
      <table>
        <thead><tr>
          <th>Project</th><th>Client</th><th>Status</th><th class="right">Budget/Rate</th><th>Domain</th><th>Creds</th><th class="right">Actions</th>
        </tr></thead>
        <tbody id="tbProjects"></tbody>
      </table>
      <p class="muted" id="emptyProjects" style="display:none;margin:12px 6px">No projects yet.</p>
    </div>

    <div class="card hidden" id="viewClients">
      <table>
        <thead><tr><th>Client</th><th>Contact</th><th>Projects</th><th class="right">Actions</th></tr></thead>
        <tbody id="tbClients"></tbody>
      </table>
      <p class="muted" id="emptyClients" style="display:none;margin:12px 6px">No clients yet.</p>
    </div>

    <div class="card hidden" id="viewInvoices">
      <table>
        <thead><tr><th>Invoice</th><th>Project</th><th>Client</th><th class="right">Amount</th><th>Status</th><th class="right">Actions</th></tr></thead>
        <tbody id="tbInvoices"></tbody>
      </table>
      <p class="muted" id="emptyInvoices" style="display:none;margin:12px 6px">No invoices yet.</p>
    </div>
  </section>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="panel">
    <h2 id="formTitle">Add</h2>

    <!-- CLIENT FORM -->
    <form id="formClient" class="hidden">
      <div class="grid">
        <label>Name<br><input id="c_name" required></label>
        <label>Email<br><input id="c_email" type="email"></label>
        <label>Phone<br><input id="c_phone" type="tel"></label>
        <label>Notes<br><textarea id="c_notes" rows="2"></textarea></label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="primary" id="saveClient">Save</button>
        <button id="cancel">Cancel</button>
        <button id="delClient" class="danger hidden">Delete</button>
      </div>
    </form>

    <!-- PROJECT FORM -->
    <form id="formProject" class="">
      <div class="grid">
        <label>Title<br><input id="p_title" required></label>
        <label>Client<br><select id="p_client" required></select></label>
        <label>Type<br>
          <select id="p_type">
            <option>Website</option><option>App</option><option>Design</option><option>Other</option>
          </select>
        </label>
        <label>Status<br>
          <select id="p_status"><option>Planned</option><option>In Progress</option><option>On Hold</option><option>Complete</option></select>
        </label>
        <label>Start Date<br><input id="p_start"></label>
        <label>End Date<br><input id="p_end"></label>
        <label>Rate Type<br>
          <select id="p_rateType"><option value="fixed">Fixed</option><option value="hourly">Hourly</option></select>
        </label>
        <label>Rate / Budget (PKR)<br><input id="p_rate" type="number" min="0" value="0"></label>
        <label>Estimated Hours (if hourly)<br><input id="p_hours" type="number" min="0" value="0"></label>
        <label>Domain<br><input id="p_domain" placeholder="example.com"></label>
        <label>Host<br><input id="p_host" placeholder="e.g., Hostinger"></label>
        <label>CMS/Stack<br><input id="p_cms" placeholder="e.g., WordPress"></label>
      </div>
      <div class="line">
        <label>Notes<br><textarea id="p_notes" rows="3"></textarea></label>
      </div>
      <details style="margin:10px 0">
        <summary><strong>Credentials (encrypted)</strong> <span class="hint">Requires Vault Key (top right)</span></summary>
        <div class="grid">
          <label>Username<br><input id="p_cred_user" placeholder="admin"></label>
          <label>Password<br><input id="p_cred_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label>
          <label>Login URL<br><input id="p_cred_url" placeholder="https://example.com/wp-admin"></label>
        </div>
      </details>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="primary" id="saveProject">Save</button>
        <button id="cancel2">Cancel</button>
        <button id="delProject" class="danger hidden">Delete</button>
      </div>
    </form>

    <!-- INVOICE FORM -->
    <form id="formInvoice" class="hidden">
      <div class="grid">
        <label>Project<br><select id="i_project" required></select></label>
        <label>Client (auto)<br><input id="i_client" disabled></label>
        <label>Invoice #<br><input id="i_number" placeholder="INV-2025-001"></label>
        <label>Date<br><input id="i_date" required></label>
        <label>Amount (PKR)<br><input id="i_amount" type="number" min="0" required></label>
        <label>Paid (PKR)<br><input id="i_paid" type="number" min="0" value="0"></label>
      </div>
      <div class="line">
        <label>Notes<br><textarea id="i_notes" rows="2"></textarea></label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="primary" id="saveInvoice">Save</button>
        <button id="cancel3">Cancel</button>
        <button id="delInvoice" class="danger hidden">Delete</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

<script>
// ---------- Firebase (replace with your project) ----------
const firebaseConfig = {
  apiKey: "AIzaSyA-mmEoY8RQMBszDpV5nrUyN2jVNJoatGU",
  authDomain: "freelancer-app-16f58.firebaseapp.com",
  projectId: "freelancer-app-16f58",
  storageBucket: "freelancer-app-16f58.appspot.com",
  messagingSenderId: "526296814867",
  appId: "1:526296814867:web:0d689aac22d0099a8cf6e6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ---------- State ----------
const state = {
  user: null,
  clients: [],
  projects: [],
  invoices: [],
  unsub: { projects: null, invoices: null },
  current: { kind: 'project', id: null },
  vaultKeyCrypto: null // CryptoKey derived from user-supplied passphrase (not stored)
};
const $$ = sel => document.querySelector(sel);
const $all = sel => [...document.querySelectorAll(sel)];

// ---------- UI helpers ----------
function toast(msg, ms=2500){ const t=$$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
function openDrawer(kind, id=null){
  state.current = { kind, id };
  $$('#drawer').style.display='flex';
  $$('#formTitle').textContent = (id? 'Edit ' : 'Add ') + kind[0].toUpperCase()+kind.slice(1);
  // toggle forms
  $$('#formClient').classList.toggle('hidden', kind!=='client');
  $$('#formProject').classList.toggle('hidden', kind!=='project');
  $$('#formInvoice').classList.toggle('hidden', kind!=='invoice');
  // delete buttons
  $$('#delClient').classList.toggle('hidden', !(kind==='client' && id));
  $$('#delProject').classList.toggle('hidden', !(kind==='project' && id));
  $$('#delInvoice').classList.toggle('hidden', !(kind==='invoice' && id));
  // hydrate selects
  hydrateClientSelects();
  hydrateProjectSelect();
  // fill fields if editing
  if(id){ fillForm(kind, id); } else { clearForm(kind); }
}
function closeDrawer(){ $$('#drawer').style.display='none'; state.current={kind:'project',id:null}; }

// ---------- Vault (Web Crypto AES-GCM) ----------
async function deriveKey(passphrase){
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const base = await crypto.subtle.importKey('raw', enc.encode(passphrase), {name:'PBKDF2'}, false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations: 120000, hash:'SHA-256'},
    base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
  return { key, salt: b64(salt) };
}
async function rederiveKey(passphrase, b64salt){
  const enc = new TextEncoder();
  const salt = b64d(b64salt);
  const base = await crypto.subtle.importKey('raw', enc.encode(passphrase), {name:'PBKDF2'}, false, ['deriveKey']);
  return await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations: 120000, hash:'SHA-256'},
    base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
}
async function encryptCreds(obj, passphrase){
  const enc = new TextEncoder();
  const {key, salt} = await deriveKey(passphrase);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(JSON.stringify(obj)));
  return { iv: b64(iv), salt, ciphertext: b64(new Uint8Array(ct)) };
}
async function decryptCreds(blob, passphrase){
  const key = await rederiveKey(passphrase, blob.salt);
  const iv = b64d(blob.iv);
  const ct = b64d(blob.ciphertext);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return JSON.parse(new TextDecoder().decode(pt));
}
function b64(arr){ return btoa(String.fromCharCode(...arr)); }
function b64d(str){ const bin = atob(str); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr; }

// ---------- Auth ----------
$$('#btnSignup').onclick = async () => {
  const email = $$('#authEmail').value.trim();
  const pass = $$('#authPass').value.trim();
  if(!email || !pass) return toast('Email & password required');
  try{ await auth.createUserWithEmailAndPassword(email, pass); toast('Account created!'); }
  catch(e){ toast(e.message); }
};
$$('#btnLogin').onclick = async () => {
  const email = $$('#authEmail').value.trim();
  const pass = $$('#authPass').value.trim();
  if(!email || !pass) return toast('Email & password required');
  try{ await auth.signInWithEmailAndPassword(email, pass); }
  catch(e){ toast(e.message); }
};
$$('#btnReset').onclick = async () => {
  const email = $$('#authEmail').value.trim();
  if(!email) return toast('Enter your email');
  try{ await auth.sendPasswordResetEmail(email); toast('Password reset sent'); }
  catch(e){ toast(e.message); }
};
$$('#btnLogout').onclick = async () => { try{ await auth.signOut(); } catch(e){ toast(e.message); } };

auth.onAuthStateChanged(user=>{
  state.user = user;
  $$('#authBox').classList.toggle('hidden', !!user);
  $$('#app').classList.toggle('hidden', !user);
  if(user){ initData(); } else { cleanup(); renderAll(); }
});

// ---------- Data: load + listeners ----------
async function initData(){
  // Load clients
  const cs = await db.collection('clients').where('userId','==',state.user.uid).get();
  state.clients = cs.docs.map(d=>({id:d.id,...d.data()}));

  // Projects realtime
  if(state.unsub.projects) state.unsub.projects();
  state.unsub.projects = db.collection('projects')
    .where('userId','==',state.user.uid)
    .onSnapshot({
      next:(snap)=>{
        state.projects = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderAll();
      },
      error:(err)=>{ console.error(err); toast('Projects error: '+err.message); }
    });

  // Invoices realtime
  if(state.unsub.invoices) state.unsub.invoices();
  state.unsub.invoices = db.collection('invoices')
    .where('userId','==',state.user.uid)
    .onSnapshot({
      next:(snap)=>{ state.invoices = snap.docs.map(d=>({id:d.id,...d.data()})); renderAll(); },
      error:(err)=>{ console.error(err); toast('Invoices error: '+err.message); }
    });
}
function cleanup(){
  if(state.unsub.projects) state.unsub.projects();
  if(state.unsub.invoices) state.unsub.invoices();
  state.clients=[]; state.projects=[]; state.invoices=[];
}

// ---------- Rendering ----------
function renderKPIs(){
  const paid = state.invoices.reduce((s,i)=>s+(+i.paid||0),0);
  const due = state.invoices.reduce((s,i)=>{ const bal=(+i.amount||0)-(+i.paid||0); return s+(bal>0?bal:0); },0);
  $$('#kpiClients').textContent = state.clients.length;
  $$('#kpiProjects').textContent = state.projects.length;
  $$('#kpiPaid').textContent = 'PKR ' + paid.toLocaleString();
  $$('#kpiDue').textContent = 'PKR ' + due.toLocaleString();
}
function renderProjects(){
  const q = $$('#q').value.trim().toLowerCase();
  const tb = $$('#tbProjects'); tb.innerHTML='';
  const filtered = state.projects.filter(p=>{
    const c = state.clients.find(x=>x.id===p.clientId)||{};
    const txt=[p.title,p.type,p.status,p.domain,p.host,p.cms,c.name,c.email,c.phone].join(' ').toLowerCase();
    return !q || txt.includes(q);
  }).sort((a,b)=> (a.status+a.title).localeCompare(b.status+b.title));
  $$('#emptyProjects').style.display = filtered.length? 'none':'block';
  filtered.forEach(p=>{
    const c = state.clients.find(x=>x.id===p.clientId)||{name:'',email:''};
    const budget = p.rateType==='hourly' ? `${(+p.rate||0).toLocaleString()} /hr ‚Ä¢ est ${(+p.estimatedHours||0)}h` : 'PKR '+(+p.rate||0).toLocaleString();
    const hasCreds = p.hasSecrets ? '<span class="badge ok">Encrypted</span>' : '<span class="badge warn">None</span>';
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${p.title}</strong><div class="muted">${p.type}</div></td>
      <td>${c.name||''}<div class="muted">${c.email||''}</div></td>
      <td><span class="badge ${p.status==='Complete'?'ok':'warn'}">${p.status}</span></td>
      <td class="right">${budget}</td>
      <td>${p.domain||''}<div class="muted">${p.host||''} ${p.cms?('‚Ä¢ '+p.cms):''}</div></td>
      <td>${hasCreds}</td>
      <td class="right">
        <div class="actions">
          <button title="Credentials">üîê</button>
          <button title="Edit">‚úèÔ∏è</button>
          <button title="Delete">üóëÔ∏è</button>
        </div>
      </td>`;
    const [btnCreds, btnEdit, btnDel] = tr.querySelectorAll('button');
    btnEdit.onclick = ()=> openDrawer('project', p.id);
    btnDel.onclick = async ()=>{ if(confirm('Delete this project?')){ await db.collection('projects').doc(p.id).delete(); toast('Project deleted'); } };
    btnCreds.onclick = ()=> viewOrEditCredentials(p.id);
    tb.appendChild(tr);
  });
}
function renderClients(){
  const q = $$('#q').value.trim().toLowerCase();
  const tb = $$('#tbClients'); tb.innerHTML='';
  const filtered = state.clients.filter(c=>{
    const txt=[c.name,c.email,c.phone,c.notes].join(' ').toLowerCase();
    return !q || txt.includes(q);
  }).sort((a,b)=> a.name.localeCompare(b.name));
  $$('#emptyClients').style.display = filtered.length? 'none':'block';
  filtered.forEach(c=>{
    const count = state.projects.filter(p=>p.clientId===c.id).length;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${c.name}</strong></td>
      <td>${c.email||''}<div class="muted">${c.phone||''}</div></td>
      <td>${count}</td>
      <td class="right">
        <div class="actions">
          <button title="Edit">‚úèÔ∏è</button>
          <button title="Delete">üóëÔ∏è</button>
        </div>
      </td>`;
    const [btnEdit, btnDel] = tr.querySelectorAll('button');
    btnEdit.onclick = ()=> openDrawer('client', c.id);
    btnDel.onclick = async ()=>{ if(confirm('Delete this client? Also delete their projects/invoices manually if needed.')){ await db.collection('clients').doc(c.id).delete(); toast('Client deleted'); } };
    tb.appendChild(tr);
  });
}
function renderInvoices(){
  const q = $$('#q').value.trim().toLowerCase();
  const tb = $$('#tbInvoices'); tb.innerHTML='';
  const filtered = state.invoices.filter(i=>{
    const p = state.projects.find(p=>p.id===i.projectId)||{};
    const c = state.clients.find(c=>c.id===i.clientId)||{};
    const txt=[i.number,i.date,i.notes,p.title,c.name,c.email,c.phone].join(' ').toLowerCase();
    return !q || txt.includes(q);
  }).sort((a,b)=> (a.date+a.number).localeCompare(b.date+b.number));
  $$('#emptyInvoices').style.display = filtered.length? 'none':'block';
  filtered.forEach(i=>{
    const p = state.projects.find(p=>p.id===i.projectId)||{};
    const c = state.clients.find(c=>c.id===i.clientId)||{};
    const bal = Math.max((+i.amount||0)-(+i.paid||0),0);
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${i.number||'(no #)'}</strong><div class="muted">${i.date||''}</div></td>
      <td>${p.title||''}</td>
      <td>${c.name||''}</td>
      <td class="right">PKR ${(+i.amount||0).toLocaleString()}</td>
      <td>${bal<=0?'<span class="badge ok">Paid</span>':'<span class="badge warn">Pending</span>'}</td>
      <td class="right">
        <div class="actions">
          <button title="Mark Paid">‚úÖ</button>
          <button title="Invoice PDF">üßæ</button>
          <button title="Edit">‚úèÔ∏è</button>
          <button title="Delete">üóëÔ∏è</button>
        </div>
      </td>`;
    const [btnPaid, btnPDF, btnEdit, btnDel] = tr.querySelectorAll('button');
    btnPaid.onclick = async ()=>{ await db.collection('invoices').doc(i.id).update({paid:i.amount}); toast('Marked as paid'); };
    btnPDF.onclick = ()=> invoicePDF(i, p, c, bal);
    btnEdit.onclick = ()=> openDrawer('invoice', i.id);
    btnDel.onclick = async ()=>{ if(confirm('Delete invoice?')){ await db.collection('invoices').doc(i.id).delete(); toast('Invoice deleted'); } };
    tb.appendChild(tr);
  });
}
function renderAll(){ renderKPIs(); renderProjects(); renderClients(); renderInvoices(); }

function hydrateClientSelects(){
  const sel = $$('#p_client'); sel.innerHTML='';
  state.clients.forEach(c=>{
    const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o);
  });
}
function hydrateProjectSelect(){
  const sel = $$('#i_project'); sel.innerHTML='';
  state.projects.forEach(p=>{
    const o=document.createElement('option'); o.value=p.id; o.textContent=p.title; sel.appendChild(o);
  });
  sel.onchange = ()=> {
    const p = state.projects.find(x=>x.id===sel.value);
    const c = state.clients.find(x=>x.id===p?.clientId);
    $$('#i_client').value = c? c.name : '';
  };
}

// ---------- Search / Tabs ----------
$$('#q').addEventListener('input', renderAll);
$all('.tab').forEach(t=> t.onclick = ()=>{
  $all('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const name = t.dataset.tab;
  $$('#viewProjects').classList.toggle('hidden', name!=='projects');
  $$('#viewClients').classList.toggle('hidden', name!=='clients');
  $$('#viewInvoices').classList.toggle('hidden', name!=='invoices');
});
$$('#btnNew').onclick = ()=>{
  const active = document.querySelector('.tab.active').dataset.tab;
  openDrawer(active.slice(0,-1)); // 'projects' -> 'project'
};

// ---------- Date pickers ----------
flatpickr('#p_start', {dateFormat:'Y-m-d'});
flatpickr('#p_end', {dateFormat:'Y-m-d'});
flatpickr('#i_date', {dateFormat:'Y-m-d'});

// ---------- Fill / Clear ----------
function clearForm(kind){
  if(kind==='client'){
    ['c_name','c_email','c_phone','c_notes'].forEach(id=> $$('#'+id).value='');
  } else if(kind==='project'){
    ['p_title','p_domain','p_host','p_cms','p_notes','p_cred_user','p_cred_pass','p_cred_url'].forEach(id=> $$('#'+id).value='');
    $$('#p_type').value='Website'; $$('#p_status').value='Planned'; $$('#p_rateType').value='fixed';
    $$('#p_rate').value='0'; $$('#p_hours').value='0'; $$('#p_start').value=''; $$('#p_end').value='';
    if(state.clients[0]) $$('#p_client').value = state.clients[0].id;
  } else if(kind==='invoice'){
    ['i_number','i_date','i_amount','i_paid','i_notes'].forEach(id=> $$('#'+id).value='');
    if(state.projects[0]){ $$('#i_project').value=state.projects[0].id; const c=state.clients.find(x=>x.id===state.projects[0].clientId); $$('#i_client').value=c?c.name:''; }
  }
}
function fillForm(kind, id){
  if(kind==='client'){
    const c = state.clients.find(x=>x.id===id); if(!c) return;
    $$('#c_name').value=c.name||''; $$('#c_email').value=c.email||''; $$('#c_phone').value=c.phone||''; $$('#c_notes').value=c.notes||'';
  } else if(kind==='project'){
    const p = state.projects.find(x=>x.id===id); if(!p) return;
    $$('#p_title').value=p.title||''; $$('#p_client').value=p.clientId||''; $$('#p_type').value=p.type||'Website';
    $$('#p_status').value=p.status||'Planned'; $$('#p_start').value=p.startDate||''; $$('#p_end').value=p.endDate||'';
    $$('#p_rateType').value=p.rateType||'fixed'; $$('#p_rate').value=p.rate||0; $$('#p_hours').value=p.estimatedHours||0;
    $$('#p_domain').value=p.domain||''; $$('#p_host').value=p.host||''; $$('#p_cms').value=p.cms||''; $$('#p_notes').value=p.notes||'';
  } else if(kind==='invoice'){
    const i = state.invoices.find(x=>x.id===id); if(!i) return;
    $$('#i_project').value=i.projectId||''; const c=state.clients.find(x=>x.id===i.clientId); $$('#i_client').value=c?c.name:'';
    $$('#i_number').value=i.number||''; $$('#i_date').value=i.date||''; $$('#i_amount').value=i.amount||0; $$('#i_paid').value=i.paid||0; $$('#i_notes').value=i.notes||'';
  }
}

// ---------- Save / Delete ----------

$$('#cancel').addEventListener('click', e=>{e.preventDefault(); closeDrawer();});
$$('#cancel2').addEventListener('click', e=>{e.preventDefault(); closeDrawer();});
$$('#cancel3').addEventListener('click', e=>{e.preventDefault(); closeDrawer();});

$$('#saveClient').onclick = async e=>{
  e.preventDefault();
  const data = {
    name: $$('#c_name').value.trim(),
    email: $$('#c_email').value.trim(),
    phone: $$('#c_phone').value.trim(),
    notes: $$('#c_notes').value.trim(),
    userId: state.user.uid,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if(!data.name) return toast('Client name required');
  try{
    if(state.current.id) { await db.collection('clients').doc(state.current.id).update(data); toast('Client updated'); }
    else { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); const ref = await db.collection('clients').add(data); state.current.id=ref.id; toast('Client added'); }
    closeDrawer();
    // refresh clients
    const cs = await db.collection('clients').where('userId','==',state.user.uid).get();
    state.clients = cs.docs.map(d=>({id:d.id,...d.data()}));
    renderAll();
  }catch(e){ console.error(e); toast('Error: '+e.message); }
};
$$('#delClient').onclick = async e=>{
  e.preventDefault(); if(!state.current.id) return;
  if(confirm('Delete this client?')){ await db.collection('clients').doc(state.current.id).delete(); toast('Client deleted'); closeDrawer(); initData(); }
};

$$('#saveProject').onclick = async e=>{
  e.preventDefault();
  const credUser=$$('#p_cred_user').value.trim();
  const credPass=$$('#p_cred_pass').value.trim();
  const credUrl=$$('#p_cred_url').value.trim();
  let encBlob=null, hasSecrets=false;

  // handle encryption if any field filled
  if(credUser || credPass || credUrl){
    const passphrase = $$('#vaultKey').value;
    if(!passphrase) return toast('Enter Vault Key to save credentials');
    try{
      encBlob = await encryptCreds({u:credUser,p:credPass,url:credUrl}, passphrase);
      hasSecrets = true;
    }catch(e){ return toast('Encrypt error: '+e.message); }
  }

  const data = {
    userId: state.user.uid,
    clientId: $$('#p_client').value,
    title: $$('#p_title').value.trim(),
    type: $$('#p_type').value,
    status: $$('#p_status').value,
    startDate: $$('#p_start').value || null,
    endDate: $$('#p_end').value || null,
    rateType: $$('#p_rateType').value,
    rate: (+$$('#p_rate').value)||0,
    estimatedHours: (+$$('#p_hours').value)||0,
    domain: $$('#p_domain').value.trim(),
    host: $$('#p_host').value.trim(),
    cms: $$('#p_cms').value.trim(),
    notes: $$('#p_notes').value.trim(),
    hasSecrets,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if(!data.title) return toast('Project title required');
  try{
    let id = state.current.id;
    if(id){ await db.collection('projects').doc(id).update(data); }
    else { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); const ref = await db.collection('projects').add(data); id=ref.id; state.current.id=id; }
    // store credentials doc if present
    if(encBlob){
      await db.collection('credentials').doc(id).set({
        userId: state.user.uid, projectId: id, enc: encBlob,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    toast(state.current.id ? 'Project saved' : 'Project created');
    closeDrawer();
  }catch(e){ console.error(e); toast('Error: '+e.message); }
};
$$('#delProject').onclick = async e=>{
  e.preventDefault(); if(!state.current.id) return;
  if(confirm('Delete this project? (Credentials doc will also be removed)')){
    await db.collection('projects').doc(state.current.id).delete();
    await db.collection('credentials').doc(state.current.id).delete().catch(()=>{});
    toast('Project deleted'); closeDrawer();
  }
};

$$('#saveInvoice').onclick = async e=>{
  e.preventDefault();
  const projId = $$('#i_project').value;
  const proj = state.projects.find(p=>p.id===projId);
  if(!proj) return toast('Select project');
  const data = {
    userId: state.user.uid,
    projectId: projId,
    clientId: proj.clientId,
    number: $$('#i_number').value.trim(),
    date: $$('#i_date').value,
    amount: (+$$('#i_amount').value)||0,
    paid: (+$$('#i_paid').value)||0,
    notes: $$('#i_notes').value.trim(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if(!data.date) return toast('Invoice date required');
  try{
    if(state.current.id){ await db.collection('invoices').doc(state.current.id).update(data); toast('Invoice updated'); }
    else { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection('invoices').add(data); toast('Invoice created'); }
    closeDrawer();
  }catch(e){ console.error(e); toast('Error: '+e.message); }
};
$$('#delInvoice').onclick = async e=>{
  e.preventDefault(); if(!state.current.id) return;
  if(confirm('Delete this invoice?')){ await db.collection('invoices').doc(state.current.id).delete(); toast('Invoice deleted'); closeDrawer(); }
};

// ---------- Credentials viewer ----------
async function viewOrEditCredentials(projectId){
  const passphrase = $$('#vaultKey').value;
  if(!passphrase) return toast('Enter Vault Key to view credentials');
  try{
    const doc = await db.collection('credentials').doc(projectId).get();
    if(!doc.exists){ return toast('No credentials saved for this project'); }
    const { enc } = doc.data();
    const obj = await decryptCreds(enc, passphrase);
    alert(`Login URL: ${obj.url||''}\nUsername: ${obj.u||''}\nPassword: ${obj.p||''}`);
  }catch(e){ console.error(e); toast('Decrypt error: '+e.message); }
}

// ---------- Export Excel ----------
$$('#btnExport').onclick = ()=>{
  const wb = XLSX.utils.book_new();

  // Clients
  const clients = state.clients.map(c=>({
    Name:c.name, Email:c.email||'', Phone:c.phone||'', Notes:c.notes||''
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clients), 'Clients');

  // Projects
  const projects = state.projects.map(p=>{
    const c = state.clients.find(x=>x.id===p.clientId)||{};
    return {
      Title:p.title, Client:c.name||'', Type:p.type, Status:p.status,
      Start:p.startDate||'', End:p.endDate||'',
      RateType:p.rateType, Rate:p.rate, EstHours:p.estimatedHours,
      Domain:p.domain||'', Host:p.host||'', CMS:p.cms||'', Notes:p.notes||'',
      HasCredentials:p.hasSecrets?'Yes':'No'
    };
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(projects), 'Projects');

  // Invoices
  const invoices = state.invoices.map(i=>{
    const p = state.projects.find(x=>x.id===i.projectId)||{};
    const c = state.clients.find(x=>x.id===i.clientId)||{};
    return {
      Number:i.number||'', Date:i.date||'', Project:p.title||'', Client:c.name||'',
      Amount:i.amount||0, Paid:i.paid||0, Balance:Math.max((+i.amount||0)-(+i.paid||0),0),
      Notes:i.notes||''
    };
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invoices), 'Invoices');

  const today = new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb, `freelancer_crm_export_${today}.xlsx`);
  toast('Exported Excel');
};

// ---------- Invoice PDF ----------
function invoicePDF(inv, proj, client, balance){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFillColor(17,17,17); doc.rect(0,0,210,22,'F');
  doc.setTextColor(255,255,255); doc.setFontSize(16); doc.text('Invoice',14,14);
  doc.setTextColor(0,0,0); doc.setFontSize(11);
  let y=30;
  doc.text(`From: Your Business`,14,y); y+=8;
  doc.text(`Bill To: ${client.name||''}`,14,y); y+=8;
  doc.text(`Project: ${proj.title||''}`,14,y); y+=8;
  doc.text(`Invoice #: ${inv.number||''}    Date: ${inv.date||''}`,14,y); y+=12;

  doc.setDrawColor(230,230,230); doc.line(14,y,196,y); y+=8;
  doc.text('Description',14,y); doc.text('Amount (PKR)',196,y,{align:'right'}); y+=8;
  doc.line(14,y,196,y); y+=8;

  doc.text('Project charges',14,y); doc.text((+inv.amount||0).toLocaleString(),196,y,{align:'right'}); y+=10;
  doc.line(14,y,196,y); y+=10;

  doc.text('Amount Paid',14,y); doc.text((+inv.paid||0).toLocaleString(),196,y,{align:'right'}); y+=8;
  doc.text('Balance Due',14,y); doc.text(balance.toLocaleString(),196,y,{align:'right'}); y+=12;
  if(inv.notes) { doc.text('Notes: '+inv.notes,14,y); y+=8; }
  doc.setFontSize(10); doc.setTextColor(107,114,128); doc.text('Thank you!',14,275);
  doc.save(`invoice_${(client.name||'client').replace(/\s+/g,'_')}_${inv.date||''}.pdf`);
}

// ---------- Events ----------
$$('#filterTab').onchange = (e)=>{
  const val = e.target.value;
  document.querySelector(`.tab[data-tab="${val}"]`).click();
};
</script>
</body>
</html>
